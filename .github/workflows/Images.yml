name: Build Image Azure Virtual Desktop

on: workflow_dispatch

env:
  LOCATION: "westeurope"
  RG_NAME_IMAGE: "Rg-AVD-Images-000101"
  IMAGE_TEMPLATE_Name: "wvd10ImageTemplate00"

jobs:

  Buid_Image_AVD:
    runs-on: windows-2019

    steps:

      - name: Log in with Azure
        uses: azure/login@v1
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'
          enable-AzPSSession: true  

      - name: Prerequis - Managed Identity - Custom Role - Resource Group
        run: |          
          'Az.ImageBuilder', 'Az.ManagedServiceIdentity', 'Az.Resources' | ForEach-Object {Install-Module -Name $_ -AllowPrerelease -Force}         
          $currentAzContext = Get-AzContext
          $subscriptionID=$currentAzContext.Subscription.Id       
          $imageResourceGroup="${{ env.RG_NAME_IMAGE }}"
          $location="${{ env.LOCATION }}"          
          $imageTemplateName="${{ env.IMAGE_TEMPLATE_Name}}"
          $runOutputName="sigOutput"
          New-AzResourceGroup -Name $imageResourceGroup -Location $location
          $timeInt=$(get-date -UFormat "%s")
          $imageRoleDefName="Azure Image Builder Image Def"+$timeInt
          $idenityName="aibIdentity"+$timeInt
          New-AzUserAssignedIdentity -ResourceGroupName $imageResourceGroup -Name $idenityName
          $idenityNameResourceId=$(Get-AzUserAssignedIdentity -ResourceGroupName $imageResourceGroup -Name $idenityName).Id
          $idenityNamePrincipalId=$(Get-AzUserAssignedIdentity -ResourceGroupName $imageResourceGroup -Name $idenityName).PrincipalId
          $aibRoleImageCreationUrl="https://raw.githubusercontent.com/azure/azvmimagebuilder/master/solutions/12_Creating_AIB_Security_Roles/aibRoleImageCreation.json"
          $aibRoleImageCreationPath = "aibRoleImageCreation.json"
          Invoke-WebRequest -Uri $aibRoleImageCreationUrl -OutFile $aibRoleImageCreationPath -UseBasicParsing
          ((Get-Content -path $aibRoleImageCreationPath -Raw) -replace '<subscriptionID>', $subscriptionID) | Set-Content -Path $aibRoleImageCreationPath
          ((Get-Content -path $aibRoleImageCreationPath -Raw) -replace '<rgName>', $imageResourceGroup) | Set-Content -Path $aibRoleImageCreationPath
          ((Get-Content -path $aibRoleImageCreationPath -Raw) -replace 'Azure Image Builder Service Image Creation Role', $imageRoleDefName) | Set-Content -Path $aibRoleImageCreationPath
          cat aibRoleImageCreation.json
          New-AzRoleDefinition -InputFile  ./aibRoleImageCreation.json
          $idenityNamePrincipalId
          Start-Sleep -s 15
          New-AzRoleAssignment -ObjectId $idenityNamePrincipalId -RoleDefinitionName $imageRoleDefName -Scope "/subscriptions/$subscriptionID/resourceGroups/$imageResourceGroup"